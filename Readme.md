# Simulate Photovoltaics and Household Meter
A simulated power meter sends its instantaneous power demand via RabbitMQ
messaging to a photovoltaics system. The PV queries present power its
pannels provide. The PV returns combined power of both entities to stdout.

Build with `./build.sh`. Depends on a recent `cargo` installation for stable Rust.

build will provide `config.toml`, with default configurations. All simulation 
and connection parameters may be set in it.

System/Network Dependency: A RabbitMQ server needs to be available.

Point of Entry: `./run.sh [file]`

`file` is optional and defaults to results.dat when no parameter is given.


# Crate Meter

This simulates the electric power meter of a household. It returns
the instantaneous power the consumer draws.

A random power value is generated by a random walk approach. A normal distributed
value is added to the previous power value.

A large `sigma` parameter leads to strong fluctuations of power.

Time is propagated mockingly by looping with `step` [s] sized steps over
the mock interval range, starting at `start` [h] and ends at `end` [h].

Sends time [s] and present power via rabbitMQ to PV.

## Parameters:
- peak power [W]
- base power [W]
- sampling interval _s_ [s]
- activity start [h]
- activity end [h]
- number of points _n_
- mock date [d], days since 2020-01-01
- mock interval [s] (default 86400)

## improvements
- use proper chrono::DateTime struct
- mock system time functions


# Crate PV
This simulates a photovoltaics system including interface to its
consumer and the power grid.

Its parameters are:
- the nominal peak power of the pv array [kW]
- orientation [deg] and tilt [deg] of the panel
  - azimuth 180 is a south facing panel
  - at a tilt of 0 a panel is horizontal
- efficiency (we calculate panel area with it)


# Crate Solarize
Solarize simulates the instantaneous insolation. It takes date [day number],
local solar time [s], and decimal latitude. It returns instantaneous
insolation [W/m^2] and zenith angle _z_ [rad] and azimuth angle _a_ [rad].

Zenith angle is calculated by: [1]

   cos z =sin l sin d + cos l cos d cos h

where:
- latitude _l_ in rad
- declination _d_ (date)
- hour angle _h_ (0 at noon, 15 degree per hour, `15 * 60^(-3) * pi` [1/s])

The suns' azimuth equals the hour angle for afternoons in the the northern
hemisphere.  Trivial corrections yield all other cases.

##Approximations:
- the sun is a considered a point source: at `cos z <= 0` there is no insolation
- no atmospheric effects but attenuation
- air-mass is approximated by `min(sec z, 40)`
  - air mass is relative attenuation compared to horizon
  - plane parallel approximation
  - cut off at 40 to address earths curvature
  - solar panel peak power is usually give for 1.5 air mass
- no weather effects, its always blue skies
- sea level
- local solar time is approximated by local standard time
- ignores leap years
- declination angle is approximated by `d_0 * cos(2 * pi * (n+10)/366)`
  - `d_0 = 0.4093` declination at the northern winter solstice 

## Improvements
- use longitude to get solar time
- add scatter light for smoother dawn/dusk

[1] http://www.atmos.albany.edu/facstaff/brose/classes/ATM623_Spring2015/Notes/Lectures/Lecture11%20--%20Insolation.html
